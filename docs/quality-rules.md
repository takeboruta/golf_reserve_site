# 開発品質ルール（テスト・デグレチェック）

## 目的

- 今後の機能修正で回帰不具合（デグレ）を防ぐため、実装と同時に検証を必須化する。

## 適用範囲

- `src/` 配下のコード変更全般
- API仕様変更、検索条件追加、表示ロジック変更を含む

## 1. 実装時の必須ルール

1. 仕様変更を伴う修正では、関連ドキュメント（`docs/`）を同一PRで更新する。
2. バグ修正では「再発防止の検証観点」をコミットメッセージまたはPR説明に明記する。
3. 条件分岐の追加時は、正常系と異常系の両方を最低1件ずつ検証する。

## 2. テストコード方針

1. 新規の業務ロジック（正規化・フィルタ・ソート）は、関数単位でテスト追加を原則とする。
2. APIルートの入力バリデーション変更時は、少なくとも以下を検証する。
   - 必須不足時の `400`
   - 正常入力時の `200`
   - 外部APIエラー時のステータスマッピング
3. UI変更時は、主要導線（検索実行、結果表示、詳細遷移）が壊れていないことを確認する。

## 3. デグレチェック（毎回必須）

コード変更後、最低限次を実行する。

1. `npm run lint`
2. `npm run build`
3. 手動スモークチェック
   - `/` で検索実行できる
   - 結果一覧が表示される
   - `詳細・カレンダー` から `/courses/[courseId]` が表示される

## 4. 変更種別ごとの追加チェック

1. 検索条件追加時
   - URLクエリの復元（リロード/戻る）
   - APIへ該当パラメータが送られること
2. 楽天連携変更時
   - 環境変数未設定時のエラー文言
   - 正常時レスポンス形状（`Items` 取り扱い）
3. カレンダー変更時
   - `days=14` と `days=30` の両方
   - `reserveUrl` の有無表示

## 5. PR チェックリスト運用

- `.github/pull_request_template.md` のチェック項目を必須で埋める。
- 未実施項目がある場合は理由を明記する。

## 6. 標準実施フロー（ルール化）

仕様変更・不具合修正・機能追加のいずれでも、以下をこの順番で実施する。

1. テスト計画更新
   - `docs/test-plan.md` の対象範囲・観点・未カバーを更新する。
2. 仕様書整合確認
   - 実装対象に対応する `docs/` と `README.md` を確認し、現行コードとの差分を解消する。
3. 過去分テスト追加
   - 未テストの既存機能（バリデーション、分岐、例外系）を先に追加し、回帰検知を強化する。
4. 変更分テスト追加・修正
   - 新仕様/修正内容に対する正常系・異常系を追加する。
5. 検証実行
   - `npm test` → `npm run lint` → `npm run build` の順に実行する。
6. 結果記録
   - PR説明に、実行コマンドと結果（成功/失敗、未実施理由）を明記する。

補足:
- 途中で失敗した場合は、原因修正後に失敗したステップから再実行する。
- 仕様書更新とテスト更新は、原則として実装と同一PRに含める。

## 7. 将来対応

- E2E（Playwright）で主要導線の自動回帰を追加し、手動スモークの負担を段階的に縮小する。
- 外部 API 呼び出しの契約テスト（モック/スタブ）を整備し、仕様変更の影響を早期検知する。
